{% extends "base.html" %}

{% block title %}Route Map - PonyXpress{% endblock %}

{% block extra_head %}
<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 8px;
    }
    
    .map-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .route-info {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .mailbox-list {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .mailbox-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .mailbox-item:hover {
        background-color: #f8f9fa;
    }
    
    .mailbox-photo {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-map"></i> Route Management</h1>
            <div>
                <button class="btn btn-success" onclick="saveRoute()">
                    <i class="bi bi-save"></i> Save Route
                </button>
                <button class="btn btn-secondary" onclick="clearRoute()">
                    <i class="bi bi-trash"></i> Clear Route
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Route Info -->
<div class="row mb-4">
    <div class="col-12">
        <div class="route-info">
            <div class="row">
                <div class="col-md-3">
                    <h6><i class="bi bi-info-circle"></i> Route Info</h6>
                    <p class="mb-1"><strong>Date:</strong> {{ route.route_date if route else 'Today' }}</p>
                    <p class="mb-1"><strong>Status:</strong> 
                        <span id="route-status" class="badge bg-{{ 'success' if route else 'warning' }}">
                            {{ 'Saved' if route else 'Not Saved' }}
                        </span>
                    </p>
                </div>
                <div class="col-md-3">
                    <h6><i class="bi bi-route"></i> Route Details</h6>
                    <p class="mb-1"><strong>Points:</strong> <span id="route-points">0</span></p>
                    <p class="mb-1"><strong>Distance:</strong> <span id="route-distance">0m</span></p>
                </div>
                <div class="col-md-3">
                    <h6><i class="bi bi-mailbox"></i> Mailbox Stops</h6>
                    <p class="mb-1"><strong>Total:</strong> <span id="mailbox-count">{{ mailbox_stops|length }}</span></p>
                    <p class="mb-1"><strong>With Photos:</strong> <span id="mailbox-photos">0</span></p>
                </div>
                <div class="col-md-3">
                    <h6><i class="bi bi-geo-alt"></i> GPS Status</h6>
                    <p class="mb-1"><strong>Location:</strong> <span id="gps-location">Getting...</span></p>
                    <p class="mb-1"><strong>Accuracy:</strong> <span id="gps-accuracy">-</span></p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Map Container -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-body p-0">
                <div id="map"></div>
                <div class="map-controls">
                    <div class="btn-group-vertical">
                        <button class="btn btn-sm btn-outline-primary" onclick="startDrawing()" title="Draw Route">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="addMailboxStop()" title="Add Mailbox Stop">
                            <i class="bi bi-mailbox"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="centerOnGPS()" title="Center on GPS">
                            <i class="bi bi-geo-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mailbox Stops Panel -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-mailbox"></i> Mailbox Stops</h5>
            </div>
            <div class="card-body">
                <div class="mailbox-list" id="mailbox-list">
                    {% if mailbox_stops %}
                        {% for stop in mailbox_stops %}
                        <div class="d-flex align-items-center mb-2 mailbox-item" 
                             onclick="centerOnMailbox({{ stop.latitude }}, {{ stop.longitude }})">
                            <div class="me-2">
                                {% if stop.photo_path %}
                                <img src="{{ url_for('static', filename='uploads/' + stop.photo_path) }}" 
                                     class="mailbox-photo" alt="Mailbox">
                                {% else %}
                                <div class="mailbox-photo bg-light d-flex align-items-center justify-content-center">
                                    <i class="bi bi-mailbox text-muted"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <small class="text-muted">Stop #{{ stop.id }}</small><br>
                                <small>{{ "%.6f"|format(stop.latitude) }}, {{ "%.6f"|format(stop.longitude) }}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="event.stopPropagation(); takePhoto({{ stop.latitude }}, {{ stop.longitude }})">
                                <i class="bi bi-camera"></i>
                            </button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted">
                            <i class="bi bi-inbox"></i> No mailbox stops yet
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Photo Upload Modal -->
<div class="modal fade" id="photoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Take Mailbox Photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="photoInput" class="form-label">Select Photo</label>
                    <input type="file" class="form-control" id="photoInput" accept="image/*" capture="environment">
                </div>
                <div id="photoPreview" class="text-center" style="display: none;">
                    <img id="previewImage" class="img-fluid rounded" style="max-height: 300px;">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadPhoto()">Upload Photo</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let map;
let routeLayer;
let mailboxLayer;
let drawingLayer;
let currentRoute = [];
let currentLocation = null;
let selectedMailboxLocation = null;

// Initialize map
function initMap() {
    // Create map centered on a default location (can be updated with GPS)
    map = L.map('map').setView([40.7128, -74.0060], 13);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
    
    // Initialize layers
    routeLayer = L.layerGroup().addTo(map);
    mailboxLayer = L.layerGroup().addTo(map);
    drawingLayer = L.layerGroup().addTo(map);
    
    // Load existing route
    {% if route and route.route_data %}
    loadExistingRoute({{ route.route_data|tojson }});
    {% endif %}
    
    // Load mailbox stops
    loadMailboxStops();
    
    // Get current location
    getCurrentLocation();
}

// Load existing route
function loadExistingRoute(routeData) {
    if (routeData && routeData.length > 0) {
        currentRoute = routeData;
        drawRoute();
        updateRouteInfo();
    }
}

// Load mailbox stops
function loadMailboxStops() {
    {% for stop in mailbox_stops %}
    addMailboxMarker({{ stop.latitude }}, {{ stop.longitude }}, {{ stop.id }}, 
                     '{{ stop.photo_path or "" }}');
    {% endfor %}
}

// Add mailbox marker
function addMailboxMarker(lat, lng, id, photoPath) {
    const icon = L.divIcon({
        html: '<i class="bi bi-mailbox" style="color: green; font-size: 20px;"></i>',
        className: 'mailbox-marker',
        iconSize: [20, 20]
    });
    
    const marker = L.marker([lat, lng], { icon: icon })
        .addTo(mailboxLayer)
        .bindPopup(`Mailbox Stop #${id}`);
    
    return marker;
}

// Draw route on map
function drawRoute() {
    routeLayer.clearLayers();
    
    if (currentRoute.length > 1) {
        const polyline = L.polyline(currentRoute, {
            color: 'blue',
            weight: 4,
            opacity: 0.7
        }).addTo(routeLayer);
        
        // Add markers for start and end points
        L.marker(currentRoute[0]).addTo(routeLayer)
            .bindPopup('Start Point');
        L.marker(currentRoute[currentRoute.length - 1]).addTo(routeLayer)
            .bindPopup('End Point');
    }
}

// Update route information
function updateRouteInfo() {
    document.getElementById('route-points').textContent = currentRoute.length;
    
    if (currentRoute.length > 1) {
        let distance = 0;
        for (let i = 1; i < currentRoute.length; i++) {
            distance += map.distance(currentRoute[i-1], currentRoute[i]);
        }
        document.getElementById('route-distance').textContent = 
            distance > 1000 ? `${(distance/1000).toFixed(1)}km` : `${Math.round(distance)}m`;
    } else {
        document.getElementById('route-distance').textContent = '0m';
    }
}

// Start drawing mode
function startDrawing() {
    map.on('click', onMapClick);
    alert('Click on the map to add route points. Click "Save Route" when done.');
}

// Handle map clicks for drawing
function onMapClick(e) {
    currentRoute.push([e.latlng.lat, e.latlng.lng]);
    drawRoute();
    updateRouteInfo();
}

// Add mailbox stop at current location
function addMailboxStop() {
    if (currentLocation) {
        // Add to current route
        currentRoute.push([currentLocation.lat, currentLocation.lng]);
        drawRoute();
        updateRouteInfo();
        
        // Add mailbox marker
        addMailboxMarker(currentLocation.lat, currentLocation.lng, Date.now());
        
        // Update mailbox count
        const count = document.getElementById('mailbox-count');
        count.textContent = parseInt(count.textContent) + 1;
    } else {
        alert('GPS location not available. Please enable location services.');
    }
}

// Get current GPS location
function getCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                currentLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                document.getElementById('gps-location').textContent = 
                    `${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}`;
                document.getElementById('gps-accuracy').textContent = 
                    `${Math.round(position.coords.accuracy)}m`;
                
                // Center map on current location
                map.setView([currentLocation.lat, currentLocation.lng], 15);
            },
            function(error) {
                document.getElementById('gps-location').textContent = 'Not available';
                document.getElementById('gps-accuracy').textContent = '-';
            }
        );
    }
}

// Center map on GPS location
function centerOnGPS() {
    if (currentLocation) {
        map.setView([currentLocation.lat, currentLocation.lng], 15);
    } else {
        alert('GPS location not available');
    }
}

// Center map on mailbox
function centerOnMailbox(lat, lng) {
    map.setView([lat, lng], 18);
}

// Clear current route
function clearRoute() {
    if (confirm('Are you sure you want to clear the current route?')) {
        currentRoute = [];
        routeLayer.clearLayers();
        updateRouteInfo();
        document.getElementById('route-status').textContent = 'Not Saved';
        document.getElementById('route-status').className = 'badge bg-warning';
    }
}

// Save route to server
function saveRoute() {
    if (currentRoute.length < 2) {
        alert('Please draw a route with at least 2 points before saving.');
        return;
    }
    
    fetch('/api/route/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            route: currentRoute
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('route-status').textContent = 'Saved';
            document.getElementById('route-status').className = 'badge bg-success';
            alert('Route saved successfully!');
        } else {
            alert('Error saving route: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error saving route: ' + error);
    });
}

// Take photo for mailbox
function takePhoto(lat, lng) {
    selectedMailboxLocation = `${lat},${lng}`;
    const modal = new bootstrap.Modal(document.getElementById('photoModal'));
    modal.show();
}

// Handle photo input change
document.getElementById('photoInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImage').src = e.target.result;
            document.getElementById('photoPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});

// Upload photo
function uploadPhoto() {
    const fileInput = document.getElementById('photoInput');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a photo first.');
        return;
    }
    
    const formData = new FormData();
    formData.append('photo', file);
    formData.append('location', selectedMailboxLocation);
    
    fetch('/api/mailbox/photo', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Photo uploaded successfully!');
            location.reload(); // Refresh to show new photo
        } else {
            alert('Error uploading photo: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error uploading photo: ' + error);
    });
}

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', function() {
    initMap();
});
</script>
{% endblock %}